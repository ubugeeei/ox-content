[tools]
rust = "1.92"
node = "24"

[env]
RUST_BACKTRACE = "1"

[tasks.build]
description = "Build everything (Rust + NAPI + npm packages)"
depends = ["build:rust", "build:napi", "build:npm"]

[tasks."build:rust"]
description = "Build Rust crates"
run = "cargo build --workspace"

[tasks."build:rust-release"]
description = "Build Rust crates in release mode"
run = "cargo build --workspace --release"

[tasks."build:napi"]
description = "Build NAPI bindings"
dir = "crates/ox_content_napi"
run = "pnpm build"

[tasks."build:npm"]
description = "Build npm packages"
depends = ["build:napi"]
run = "pnpm -r --filter './npm/*' run build"

[tasks."build:wasm"]
description = "Build WASM bindings"
dir = "crates/ox_content_wasm"
run = "wasm-pack build --target web --out-dir pkg"

[tasks.test]
description = "Run all tests (Rust + TypeScript)"
depends = ["test:rust", "test:ts"]

[tasks."test:rust"]
description = "Run Rust tests"
run = "cargo test --workspace"

[tasks."test:rust-verbose"]
description = "Run Rust tests with verbose output"
run = "cargo test --workspace -- --nocapture"

[tasks."test:ts"]
description = "Run TypeScript tests with vitest"
run = "pnpm test"

[tasks.check]
description = "Check all (Rust + TypeScript)"
depends = ["check:rust", "check:ts"]

[tasks."check:rust"]
description = "Check Rust crates"
run = "cargo check --workspace"

[tasks.clippy]
description = "Run clippy on all crates"
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks.fmt]
description = "Format all code (Rust + TypeScript)"
depends = ["fmt:rust", "fmt:ts"]

[tasks."fmt:rust"]
description = "Format Rust code"
run = "cargo fmt --all"

[tasks."fmt:check"]
description = "Check all formatting"
depends = ["fmt:rust-check", "fmt:ts-check"]

[tasks."fmt:rust-check"]
description = "Check Rust formatting"
run = "cargo fmt --all -- --check"

[tasks."fmt:ts"]
description = "Format TypeScript code"
run = "pnpm fmt"

[tasks."fmt:ts-check"]
description = "Check TypeScript formatting"
run = "pnpm fmt:check"

[tasks.lint]
description = "Run all lints (Rust + TypeScript)"
depends = ["lint:rust", "lint:ts"]

[tasks."lint:rust"]
description = "Run Rust lints (clippy)"
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks."lint:ts"]
description = "Run TypeScript lints (oxlint)"
run = "pnpm lint"

[tasks."check:ts"]
description = "Run TypeScript type check"
run = "pnpm check"

[tasks.bench]
description = "Run all benchmarks (Rust + JS)"
depends = ["bench:rust", "bench:parse", "bench:bundle"]

[tasks."bench:rust"]
description = "Run Rust benchmarks"
run = "cargo bench --workspace"

[tasks."bench:parse"]
description = "Run parse/render speed benchmarks"
run = "pnpm -r --filter='ox-content-bundle-size-benchmark' run benchmark:parse"

[tasks."bench:bundle"]
description = "Run bundle size benchmarks"
run = "pnpm -r --filter='ox-content-bundle-size-benchmark' run benchmark"

[tasks."doc:cargo"]
description = "Generate Rust documentation"
run = "cargo doc --workspace --no-deps"

[tasks."doc:cargo-open"]
description = "Generate and open Rust documentation"
run = "cargo doc --workspace --no-deps --open"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.napi-prepublish]
description = "Prepare NAPI package for publishing"
dir = "crates/ox_content_napi"
run = "napi prepublish"

[tasks.ci]
description = "Run CI checks"
depends = ["fmt:check", "lint", "test"]

[tasks.ready]
description = "Run all checks before committing"
depends = ["fmt", "lint", "test"]

[tasks.coverage]
description = "Generate test coverage report"
run = "cargo llvm-cov --workspace --html"

[tasks.setup]
description = "Setup development environment"
run = """
rustup component add clippy rustfmt
cargo install cargo-watch cargo-llvm-cov
"""

[tasks.watch]
description = "Watch for changes and run tests"
run = "cargo watch -x test"

[tasks.watch-check]
description = "Watch for changes and run check"
run = "cargo watch -x check"

[tasks.playground]
description = "Start the playground"
dir = "examples/playground"
run = "pnpm run dev"

[tasks.integ-vue]
description = "Start Vue integration example"
dir = "examples/integ-vue"
run = "pnpm run dev"

[tasks.integ-react]
description = "Start React integration example"
dir = "examples/integ-react"
run = "pnpm run dev"

[tasks.integ-svelte]
description = "Start Svelte integration example"
dir = "examples/integ-svelte"
run = "pnpm run dev"

[tasks.ssg-vite]
description = "Start Vite SSG example"
dir = "examples/ssg-vite"
run = "pnpm run dev"

[tasks.plugin-markdown-it]
description = "Run markdown-it plugin example"
dir = "examples/plugin-markdown-it"
run = "pnpm run start"

[tasks.plugin-rehype]
description = "Run rehype plugin example"
dir = "examples/plugin-rehype"
run = "pnpm run start"

[tasks.gen-source-docs]
description = "Run source docs generator example"
dir = "examples/gen-source-docs"
run = "pnpm run dev"

[tasks.dev]
description = "Start documentation dev server"
depends = ["build:npm"]
dir = "docs"
run = "pnpm dev"

[tasks.dev-build]
description = "Build documentation site"
depends = ["build:npm"]
dir = "docs"
run = "pnpm build"

[tasks.dev-preview]
description = "Preview documentation build"
dir = "docs"
run = "pnpm preview"

[tasks.install]
description = "Install all dependencies with pnpm"
run = "pnpm install"

[tasks.release]
description = "Release a new version"
usage = '''
arg "<version>" help="Version bump type (alpha|beta|patch|minor|major) or explicit version (x.y.z)"
'''
run = "node --experimental-strip-types scripts/release.ts ${usage_version}"

[tasks.examples-install]
description = "Install all example dependencies"
depends = ["install"]
